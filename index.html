<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë„ ì² ì¸ ë¼ë³´ì¹´?</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        #memberSelect:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: auto;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-secondary.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary.active:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .sport-tabs {
            display: flex;
            gap: 0;
        }

        .sport-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f5f5f5;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .sport-tab:hover {
            background: #e0e0e0;
        }

        .sport-tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-danger:hover {
            background: #ff3838;
        }

        .btn-kakao {
            background: #fee500;
            color: #000;
        }

        .btn-kakao:hover {
            background: #fdd835;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            margin: 5px;
        }

        .member-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .member-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .member-card.active {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .stats-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #fee500;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: width 0.5s;
            color: #000;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .history-item-details {
            font-size: 14px;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
        }

        .badge-swim {
            background: #2196F3;
            color: white;
        }

        .badge-run {
            background: #4CAF50;
            color: white;
        }

        .badge-cycle {
            background: #FF9800;
            color: white;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .comparison-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .comparison-card h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #667eea;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .hidden {
            display: none;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-buttons .btn {
            flex: 1;
        }

        .ranking-list {
            margin-top: 15px;
        }

        .ranking-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-number {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .icon {
            font-size: 20px;
        }

        .icon-img {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <img src="images/iron-man.png" alt="ì•„ì´ì–¸ë§¨" class="icon-img" style="width: 24px; height: 24px;">
                ë‚˜ë„ ì² ì¸ ë¼ë³´ì¹´?
            </h1>
            <p>ëª©í‘œ ë‹¬ì„±ì„ í–¥í•œ ì—¬ì •ì„ í•¨ê»˜í•˜ì„¸ìš”</p>
        </div>

        <div class="content">
            <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="nav-buttons" id="navButtons">
                <button class="btn btn-secondary" onclick="showSection('register')" data-section="register">ë©¤ë²„ ë“±ë¡</button>
                <button class="btn btn-secondary" onclick="showSection('mileage')" data-section="mileage">ë§ˆì¼ë¦¬ì§€ ê´€ë¦¬</button>
                <button class="btn btn-secondary" onclick="showSection('history')" data-section="history">ì´ë ¥ ì¡°íšŒ</button>
            </div>

            <!-- ë©¤ë²„ ë“±ë¡ ì„¹ì…˜ -->
            <div id="registerSection" class="section">
                <h2 class="section-title">
                    <span class="icon">ğŸ‘¤</span>
                    ë©¤ë²„ ë“±ë¡
                </h2>
                <div id="registerAlert"></div>
                <div class="form-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="memberName" placeholder="ë©¤ë²„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <label>ì¢…ëª© ì„ íƒ</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="radio" id="sportSwim" name="sport" value="ìˆ˜ì˜" onchange="updateRegisterButtonText()">
                            <label for="sportSwim">ìˆ˜ì˜</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="sportRun" name="sport" value="ëŸ¬ë‹" onchange="updateRegisterButtonText()">
                            <label for="sportRun">ëŸ¬ë‹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="radio" id="sportCycle" name="sport" value="ì‚¬ì´í´" onchange="updateRegisterButtonText()">
                            <label for="sportCycle">ì‚¬ì´í´</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>ë…„ë„</label>
                    <select id="memberYear" onchange="updateRegisterButtonText()"></select>
                </div>
                <div class="form-group">
                    <label>ì›”</label>
                    <select id="memberMonth" onchange="updateRegisterButtonText()"></select>
                </div>
                <div class="form-group">
                    <label>ëª©í‘œ ë§ˆì¼ë¦¬ì§€ (m)</label>
                    <input type="number" id="targetMileage" placeholder="ëª©í‘œ ê±°ë¦¬ë¥¼ ë¯¸í„° ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”" min="0" oninput="updateRegisterButtonText()">
                </div>
                <button class="btn btn-primary" id="registerMemberBtn" onclick="registerMember()">ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë“±ë¡</button>
            </div>

            <!-- ë§ˆì¼ë¦¬ì§€ ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="mileageSection" class="section hidden">
                <h2 class="section-title">
                    <span class="icon">ğŸ“Š</span>
                    ë§ˆì¼ë¦¬ì§€ ê´€ë¦¬
                </h2>
                
                <!-- ë©¤ë²„ ì„ íƒ -->
                <div class="form-group">
                    <label>ë©¤ë²„ ì„ íƒ</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="memberSelect" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;" onchange="onMemberSelectChange()">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <div class="checkbox-item" style="margin: 0; white-space: nowrap;">
                            <input type="checkbox" id="fixedMemberCheckbox" onchange="fixedSelectedMember()">
                            <label for="fixedMemberCheckbox" style="margin: 0; font-size: 14px; cursor: pointer;">ì„ íƒ ë©¤ë²„ ê³ ì •</label>
                        </div>
                    </div>
                </div>

                <!-- ë§ˆì¼ë¦¬ì§€ ë“±ë¡ -->
                <div id="mileageForm" class="form-group hidden">
                    <h3 class="section-title" style="font-size: 16px;">
                        <span class="icon">â•</span>
                        ë§ˆì¼ë¦¬ì§€ ë“±ë¡
                    </h3>
                    <div class="form-group">
                        <label>ì¢…ëª©</label>
                        <select id="mileageSport" onchange="onMileageSportChange()"></select>
                    </div>
                    <div class="form-group">
                        <label>ë…„ë„</label>
                        <select id="mileageYear" onchange="onMileageDateChange()"></select>
                    </div>
                    <div class="form-group">
                        <label>ì›”</label>
                        <select id="mileageMonth" onchange="onMileageDateChange()"></select>
                    </div>
                    <div class="form-group">
                        <label>ë§ˆì¼ë¦¬ì§€ (m)</label>
                        <input type="number" id="mileageDistance" placeholder="ê±°ë¦¬ë¥¼ ë¯¸í„° ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”" min="0" step="0.01" oninput="updateMileageButtonText()">
                        <div id="existingMileageInfo" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                    </div>
                    <button class="btn btn-primary" id="addMileageBtn" onclick="addOrUpdateMileage()">ë§ˆì¼ë¦¬ì§€ ì¶”ê°€</button>
                </div>

                <!-- í˜„í™© í‘œì‹œ -->
                <div id="mileageStats" class="hidden">
                    <!-- ì¢…ëª©ë³„ íƒ­ -->
                    <div id="sportTabs" class="sport-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;"></div>

                    <div class="stats-card">
                        <h3>
                            <span class="icon">ğŸ¯</span>
                            ëª©í‘œ ë‹¬ì„±ë¥ 
                        </h3>
                        <div id="progressContainer"></div>
                    </div>

                    <div class="chart-container">
                        <h3 class="section-title" style="font-size: 16px;">
                            <span class="icon">ğŸ“ˆ</span>
                            <span id="yearlyChartTitle">ë…„ë„ë³„ ëª©í‘œ ë‹¬ì„±ë¥  ì¶”ì´</span>
                        </h3>
                        <div style="position: relative; height: 400px;">
                            <canvas id="yearlyChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="section-title" style="font-size: 16px;">
                            <span class="icon">âš–ï¸</span>
                            ë©¤ë²„ ë¹„êµ
                        </h3>
                        <div class="form-group">
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <select id="compareMemberSelect" style="flex: 1; min-width: 200px; width: 100%;">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <button class="btn btn-primary" onclick="addCompareMember()" style="white-space: nowrap;">ì¶”ê°€</button>
                            </div>
                        </div>
                        <div id="comparisonContainer" class="comparison-container"></div>
                    </div>

                    <button class="btn btn-kakao" onclick="shareKakao()" style="margin-top: 20px;">
                        <span class="icon">ğŸ’¬</span>
                        ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•˜ê¸°
                    </button>
                </div>
            </div>

            <!-- ì´ë ¥ ì¡°íšŒ ì„¹ì…˜ -->
            <div id="historySection" class="section hidden">
                <h2 class="section-title">
                    <span class="icon">ğŸ“‹</span>
                    ì´ë ¥ ì¡°íšŒ
                </h2>
                <div class="form-group">
                    <label>ë©¤ë²„ ì„ íƒ</label>
                    <select id="historyMember" onchange="loadHistory()">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì´ˆê¸°í™”
        const supabaseUrl = 'https://tsropshzbqrfladkgwsr.supabase.co';
        const supabaseKey = 'sb_publishable_13HduBGv5qjNmCusvyfkMw_fcV1V6Jm';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // ì¹´ì¹´ì˜¤í†¡ SDK ì´ˆê¸°í™”
        Kakao.init('41ec28afdb74a9849655aeb3dc4096aa');

        let currentMember = null;
        let allMembers = [];
        let currentSport = 'ìˆ˜ì˜'; // ê¸°ë³¸ ì„ íƒ ì¢…ëª©
        let compareMembersBySport = { // ì¢…ëª©ë³„ ë¹„êµ ëŒ€ìƒ ë©¤ë²„ ëª©ë¡
            'ìˆ˜ì˜': [],
            'ëŸ¬ë‹': [],
            'ì‚¬ì´í´': []
        };
        let yearlyChartInstance = null; // Chart.js ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOMì´ ì™„ì „íˆ ë¡œë“œë˜ë„ë¡ í•¨
            setTimeout(function() {
                initializeYearMonth();
                loadMembers().then(() => {
                    // ë©¤ë²„ ë¡œë“œ í›„ ì €ì¥ëœ ë©¤ë²„ ìë™ ì„ íƒ
                    loadFixedMember();
                });
                showSection('mileage');
            }, 100);
        });

        // ë…„ë„/ì›” ì„ íƒ ì˜µì…˜ ì´ˆê¸°í™”
        function initializeYearMonth() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // ë©¤ë²„ ë“±ë¡ìš©
            const memberYear = document.getElementById('memberYear');
            const memberMonth = document.getElementById('memberMonth');
            
            // ë§ˆì¼ë¦¬ì§€ ë“±ë¡ìš©
            const mileageYear = document.getElementById('mileageYear');
            const mileageMonth = document.getElementById('mileageMonth');

            // ìš”ì†Œ ì¡´ì¬ í™•ì¸
            if (!memberYear || !memberMonth || !mileageYear || !mileageMonth) {
                console.error('Select box ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('memberYear:', memberYear, 'memberMonth:', memberMonth, 'mileageYear:', mileageYear, 'mileageMonth:', mileageMonth);
                return;
            }

            // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            memberYear.innerHTML = '';
            memberMonth.innerHTML = '';
            mileageYear.innerHTML = '';
            mileageMonth.innerHTML = '';

            // 2026ë…„ë¶€í„° ì´í›„ 10ë…„ (2026~2035)
            const startYear = 2026;
            const endYear = 2035;
            const defaultYear = Math.max(startYear, Math.min(currentYear, endYear));

            console.log('ë…„ë„ ì´ˆê¸°í™”:', startYear, '~', endYear, 'ê¸°ë³¸ê°’:', defaultYear);

            for (let year = startYear; year <= endYear; year++) {
                const option1 = document.createElement('option');
                option1.value = year;
                option1.textContent = year + 'ë…„';
                if (year === defaultYear) option1.selected = true;
                memberYear.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = year;
                option2.textContent = year + 'ë…„';
                if (year === defaultYear) option2.selected = true;
                mileageYear.appendChild(option2);
            }

            console.log('ë…„ë„ ì˜µì…˜ ì¶”ê°€ ì™„ë£Œ. memberYear ì˜µì…˜ ìˆ˜:', memberYear.options.length, 'mileageYear ì˜µì…˜ ìˆ˜:', mileageYear.options.length);

            for (let month = 1; month <= 12; month++) {
                const option1 = document.createElement('option');
                option1.value = month;
                option1.textContent = month + 'ì›”';
                if (month === currentMonth) option1.selected = true;
                memberMonth.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = month;
                option2.textContent = month + 'ì›”';
                if (month === currentMonth) option2.selected = true;
                mileageMonth.appendChild(option2);
            }
        }

        // ì„¹ì…˜ ì „í™˜
        function showSection(section) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('registerSection').classList.add('hidden');
            document.getElementById('mileageSection').classList.add('hidden');
            document.getElementById('historySection').classList.add('hidden');

            // ëª¨ë“  íƒ­ ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.nav-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ì„ íƒëœ íƒ­ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            const activeButton = document.querySelector(`.nav-buttons .btn[data-section="${section}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            if (section === 'register') {
                document.getElementById('registerSection').classList.remove('hidden');
                // ë…„ë„/ì›” ì˜µì…˜ì´ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ì‹œ ì´ˆê¸°í™”
                if (document.getElementById('memberYear').options.length === 0) {
                    initializeYearMonth();
                }
            } else if (section === 'mileage') {
                document.getElementById('mileageSection').classList.remove('hidden');
                loadMembers();
                // ë…„ë„/ì›” ì˜µì…˜ì´ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ì‹œ ì´ˆê¸°í™”
                if (document.getElementById('mileageYear').options.length === 0) {
                    initializeYearMonth();
                }
            } else if (section === 'history') {
                document.getElementById('historySection').classList.remove('hidden');
                loadHistoryMembers();
            }
        }

        // ì´ë ¥ ì¡°íšŒìš© ë©¤ë²„ ëª©ë¡ ë¡œë“œ
        async function loadHistoryMembers() {
            try {
                const { data, error } = await supabaseClient
                    .from('iron_members')
                    .select('*')
                    .order('name');

                if (error) throw error;

                allMembers = data || [];
                updateHistoryMemberSelect();
                
                // ì €ì¥ëœ ë©¤ë²„ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ ë° ì´ë ¥ ë¡œë“œ
                const fixedMemberId = localStorage.getItem('fixedMemberId');
                if (fixedMemberId) {
                    const member = allMembers.find(m => m.id === fixedMemberId);
                    if (member) {
                        const historyMemberSelect = document.getElementById('historyMember');
                        historyMemberSelect.value = fixedMemberId;
                        loadHistory();
                    }
                }
            } catch (error) {
                console.error('ë©¤ë²„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë©¤ë²„ ëª©ë¡ ë¡œë“œ
        async function loadMembers() {
            try {
                const { data, error } = await supabaseClient
                    .from('iron_members')
                    .select('*')
                    .order('name');

                if (error) throw error;

                allMembers = data || [];
                displayMemberList();
                updateHistoryMemberSelect();
                // updateCompareMemberSelectsëŠ” selectMemberì—ì„œ í˜¸ì¶œë¨
                return Promise.resolve();
            } catch (error) {
                console.error('ë©¤ë²„ ë¡œë“œ ì˜¤ë¥˜:', error);
                return Promise.reject(error);
            }
        }

        // ë©¤ë²„ ëª©ë¡ í‘œì‹œ (select boxì— ì˜µì…˜ ì¶”ê°€)
        function displayMemberList() {
            const memberSelect = document.getElementById('memberSelect');
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì„ íƒí•˜ì„¸ìš” ì œì™¸)
            while (memberSelect.options.length > 1) {
                memberSelect.remove(1);
            }

            allMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                option.dataset.member = JSON.stringify(member);
                memberSelect.appendChild(option);
            });

            // ì €ì¥ëœ ë©¤ë²„ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
            loadFixedMember();
        }

        // ë©¤ë²„ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸
        function onMemberSelectChange() {
            const memberSelect = document.getElementById('memberSelect');
            const selectedValue = memberSelect.value;
            const saveCheckbox = document.getElementById('fixedMemberCheckbox');
            
            if (!selectedValue) {
                currentMember = null;
                document.getElementById('mileageForm').classList.add('hidden');
                document.getElementById('mileageStats').classList.add('hidden');
                saveCheckbox.checked = false;
                localStorage.removeItem('fixedMemberId');
                return;
            }

            const selectedOption = memberSelect.options[memberSelect.selectedIndex];
            const member = JSON.parse(selectedOption.dataset.member);
            selectMember(member);
            
            // ì €ì¥ëœ ë©¤ë²„ì™€ ì¼ì¹˜í•˜ë©´ ì²´í¬ë°•ìŠ¤ ì²´í¬
            const fixedMemberId = localStorage.getItem('fixedMemberId');
            saveCheckbox.checked = (fixedMemberId === selectedValue);
        }

        // ë©¤ë²„ ì„ íƒ
        async function selectMember(member) {
            currentMember = member;

            // ë§ˆì¼ë¦¬ì§€ ë“±ë¡ í¼ í‘œì‹œ
            document.getElementById('mileageForm').classList.remove('hidden');
            updateMileageSportSelect(member);
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë…„ë„ì™€ ì›” ì„¤ì •
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            
            const mileageYear = document.getElementById('mileageYear');
            const mileageMonth = document.getElementById('mileageMonth');
            
            if (mileageYear) mileageYear.value = currentYear;
            if (mileageMonth) mileageMonth.value = currentMonth;
            
            // ë©¤ë²„ì˜ ì¢…ëª©ì— ë”°ë¼ íƒ­ ìƒì„±
            createSportTabs(member);
            
            // ë¹„êµ ë©¤ë²„ ì„ íƒ ëª©ë¡ ì—…ë°ì´íŠ¸ (í˜„ì¬ ì¢…ëª© ê¸°ì¤€)
            await updateCompareMemberSelects();
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('mileageDistance').value = '';
            document.getElementById('existingMileageInfo').innerHTML = '';
            
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            updateMileageButtonText();
            
            // ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ ì¡°íšŒ
            loadExistingMileage();
            
            // í˜„í™© ë¡œë“œ
            loadMileageStats();
            
            // ë¹„êµ í‘œì‹œ ì—…ë°ì´íŠ¸
            await updateComparison();
        }

        // ì„ íƒ ë©¤ë²„ ê³ ì •
        function fixedSelectedMember() {
            const checkbox = document.getElementById('fixedMemberCheckbox');
            const memberSelect = document.getElementById('memberSelect');
            
            if (checkbox.checked && memberSelect.value) {
                localStorage.setItem('fixedMemberId', memberSelect.value);
            } else {
                localStorage.removeItem('fixedMemberId');
            }
        }

        // ê³ ì •ëœ ë©¤ë²„ ë¡œë“œ
        function loadFixedMember() {
            const fixedMemberId = localStorage.getItem('fixedMemberId');
            if (fixedMemberId && allMembers.length > 0) {
                const member = allMembers.find(m => m.id === fixedMemberId);
                if (member) {
                    const memberSelect = document.getElementById('memberSelect');
                    memberSelect.value = fixedMemberId;
                    document.getElementById('fixedMemberCheckbox').checked = true;
                    selectMember(member);
                }
            }
        }

        // ë§ˆì¼ë¦¬ì§€ ì¢…ëª© ì„ íƒ ì—…ë°ì´íŠ¸
        function updateMileageSportSelect(member) {
            const sportSelect = document.getElementById('mileageSport');
            sportSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            const sports = member.sports ? member.sports.split(',') : [];
            sports.forEach(sport => {
                const option = document.createElement('option');
                option.value = sport.trim();
                option.textContent = sport.trim();
                sportSelect.appendChild(option);
            });
        }

        // ë…„ë„/ì›” ë³€ê²½ ì´ë²¤íŠ¸
        async function onMileageDateChange() {
            loadExistingMileage();
            updateMileageButtonText();
            if (currentMember) {
                loadMileageStats();
                await updateComparison();
            }
        }

        // ì¢…ëª© ë³€ê²½ ì‹œ
        function onMileageSportChange() {
            loadExistingMileage();
            updateMileageButtonText();
        }

        // ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ ì¡°íšŒ ë° í‘œì‹œ (ëˆ„ì  í•©ê³„)
        async function loadExistingMileage() {
            if (!currentMember) return;

            const sport = document.getElementById('mileageSport').value;
            const year = document.getElementById('mileageYear').value;
            const month = document.getElementById('mileageMonth').value;
            const infoDiv = document.getElementById('existingMileageInfo');
            const distanceInput = document.getElementById('mileageDistance');

            if (!sport || !year || !month) {
                infoDiv.innerHTML = '';
                distanceInput.value = '';
                return;
            }

            try {
                // í•´ë‹¹ ë…„ë„/ì›”/ì¢…ëª©ì˜ ëª¨ë“  ë§ˆì¼ë¦¬ì§€ ë ˆì½”ë“œ ì¡°íšŒ
                const { data, error } = await supabaseClient
                    .from('iron_mileages')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .eq('sport', sport)
                    .eq('year', parseInt(year))
                    .eq('month', parseInt(month))
                    .order('created_at', { ascending: false });

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                if (data && data.length > 0) {
                    // ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ë“¤ì˜ í•©ê³„ ê³„ì‚°
                    const totalMileage = data.reduce((sum, item) => sum + item.distance, 0);
                    const recordCount = data.length;
                    const km = Math.floor((totalMileage / 1000) * 100) / 100;
                    const kmText = km.toFixed(2);
                    
                    // ì…ë ¥ í•„ë“œëŠ” ë¹„ì›Œë‘  (ìƒˆë¡œìš´ ë§ˆì¼ë¦¬ì§€ë§Œ ì…ë ¥)
                    distanceInput.value = '';
                    
                    // ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ í•©ê³„ í‘œì‹œ
                    infoDiv.innerHTML = `<span style="color: #2e7d32;">âœ“ í˜„ì¬ ëˆ„ì  ë§ˆì¼ë¦¬ì§€: ${totalMileage.toLocaleString()}m (${kmText} km) - ${recordCount}ê±´ ë“±ë¡ë¨</span>`;
                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    updateMileageButtonText();
                } else {
                    // ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ê°€ ì—†ëŠ” ê²½ìš°
                    distanceInput.value = '';
                    infoDiv.innerHTML = '<span style="color: #666;">ìƒˆë¡œìš´ ë§ˆì¼ë¦¬ì§€ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.</span>';
                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    updateMileageButtonText();
                }
            } catch (error) {
                console.error('ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ ì¡°íšŒ ì˜¤ë¥˜:', error);
                distanceInput.value = '';
                infoDiv.innerHTML = '';
            }
        }

        // ë§ˆì¼ë¦¬ì§€ ì¶”ê°€ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateMileageButtonText() {
            const sport = document.getElementById('mileageSport').value;
            const distance = parseFloat(document.getElementById('mileageDistance').value);
            const addMileageBtn = document.getElementById('addMileageBtn');
            
            if (!addMileageBtn) return;
            
            if (sport && distance && distance > 0) {
                // ë¯¸í„°ë¥¼ kmë¡œ í™˜ì‚°í•˜ê³  ì†Œìˆ˜ì  ë‘ ë²ˆì§¸ ìë¦¬ê¹Œì§€ë§Œ í‘œì‹œ (ë²„ë¦¼)
                const km = Math.floor((distance / 1000) * 100) / 100;
                const kmText = km.toFixed(2);
                addMileageBtn.textContent = `${sport} ${kmText} km ë§ˆì¼ë¦¬ì§€ ì¶”ê°€`;
            } else {
                addMileageBtn.textContent = 'ë§ˆì¼ë¦¬ì§€ ì¶”ê°€';
            }
        }

        // ë“±ë¡ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateRegisterButtonText() {
            const year = document.getElementById('memberYear').value;
            const month = document.getElementById('memberMonth').value;
            const targetMileage = parseFloat(document.getElementById('targetMileage').value);
            const selectedSport = document.querySelector('input[name="sport"]:checked');
            
            const registerBtn = document.getElementById('registerMemberBtn');
            if (!registerBtn) return;
            
            if (year && month && selectedSport && targetMileage && targetMileage > 0) {
                // ë¯¸í„°ë¥¼ kmë¡œ í™˜ì‚°í•˜ê³  ì†Œìˆ˜ì  ë‘ ë²ˆì§¸ ìë¦¬ê¹Œì§€ë§Œ í‘œì‹œ (ë²„ë¦¼)
                const targetKm = Math.floor((targetMileage / 1000) * 100) / 100;
                const targetKmText = targetKm.toFixed(2);
                registerBtn.textContent = `${selectedSport.value} ${targetKmText} km ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë“±ë¡`;
            } else {
                registerBtn.textContent = 'ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë“±ë¡';
            }
        }

        // ë©¤ë²„ ë“±ë¡
        async function registerMember() {
            const name = document.getElementById('memberName').value.trim();
            const year = parseInt(document.getElementById('memberYear').value);
            const month = parseInt(document.getElementById('memberMonth').value);
            const targetMileage = parseFloat(document.getElementById('targetMileage').value);

            // ë¼ë””ì˜¤ ë²„íŠ¼ì—ì„œ ì„ íƒëœ ì¢…ëª© ê°€ì ¸ì˜¤ê¸°
            const selectedSport = document.querySelector('input[name="sport"]:checked');
            
            if (!name) {
                showAlert('registerAlert', 'ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            if (!selectedSport) {
                showAlert('registerAlert', 'ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const sports = [selectedSport.value];
            const sport = selectedSport.value;

            if (!targetMileage || targetMileage <= 0) {
                showAlert('registerAlert', 'ëª©í‘œ ë§ˆì¼ë¦¬ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                // 1. ë©¤ë²„ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ (ì´ë¦„ë§Œìœ¼ë¡œ)
                let { data: existingMember, error: memberError } = await supabaseClient
                    .from('iron_members')
                    .select('*')
                    .eq('name', name)
                    .single();

                if (memberError && memberError.code !== 'PGRST116') {
                    throw memberError;
                }

                let memberId;
                if (!existingMember) {
                    // ë©¤ë²„ê°€ ì—†ìœ¼ë©´ ìƒì„±
                    const { data: newMember, error: insertError } = await supabaseClient
                        .from('iron_members')
                        .insert([
                            {
                                name: name,
                                sports: sports.join(',')
                            }
                        ])
                        .select()
                        .single();

                    if (insertError) throw insertError;
                    memberId = newMember.id;
                } else {
                    // ë©¤ë²„ê°€ ìˆìœ¼ë©´ ID ì‚¬ìš©
                    memberId = existingMember.id;
                    
                    // ì¢…ëª©ì´ sportsì— ì—†ìœ¼ë©´ ì¶”ê°€
                    const memberSports = existingMember.sports ? existingMember.sports.split(',') : [];
                    if (!memberSports.includes(sport)) {
                        memberSports.push(sport);
                        await supabaseClient
                            .from('iron_members')
                            .update({ sports: memberSports.join(',') })
                            .eq('id', memberId);
                    }
                }

                // 2. ë™ì¼ ë…„ë„/ì›”/ì¢…ëª©ì˜ ê¸°ì¡´ ë ˆì½”ë“œ í™•ì¸
                const { data: existingRecord, error: recordError } = await supabaseClient
                    .from('iron_member_records')
                    .select('*')
                    .eq('member_id', memberId)
                    .eq('year', year)
                    .eq('month', month)
                    .eq('sport', sport)
                    .single();

                if (recordError && recordError.code !== 'PGRST116') {
                    throw recordError;
                }

                if (existingRecord) {
                    // ê¸°ì¡´ ë ˆì½”ë“œê°€ ìˆëŠ” ê²½ìš°
                    const existingTargetKm = (Math.floor(existingRecord.target_mileage / 100) / 10).toFixed(1);
                    const newTargetKm = (Math.floor(targetMileage / 100) / 10).toFixed(1);
                    
                    const confirmMessage = `ë™ì¼í•œ ì´ë¦„(${name}), ë…„ë„/ì›”(${year}ë…„ ${month}ì›”), ì¢…ëª©(${sport})ì˜ ëª©í‘œ ë§ˆì¼ë¦¬ì§€ê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\nê¸°ì¡´: ${sport} - ${existingTargetKm}km\nìƒˆë¡œìš´: ${sport} - ${newTargetKm}km\n\nëª©í‘œ ë§ˆì¼ë¦¬ì§€ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    
                    if (confirm(confirmMessage)) {
                        // ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë ˆì½”ë“œ ì—…ë°ì´íŠ¸
                        const { error: updateError } = await supabaseClient
                            .from('iron_member_records')
                            .update({
                                target_mileage: targetMileage
                            })
                            .eq('id', existingRecord.id);

                        if (updateError) throw updateError;

                        showAlert('registerAlert', 'ëª©í‘œ ë§ˆì¼ë¦¬ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        
                        // í¼ ì´ˆê¸°í™”
                        document.getElementById('memberName').value = '';
                        document.getElementById('targetMileage').value = '';
                        const sportRadios = document.querySelectorAll('input[name="sport"]');
                        sportRadios.forEach(radio => radio.checked = false);
                        
                        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                        updateRegisterButtonText();

                        // ë©¤ë²„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        setTimeout(() => {
                            loadMembers();
                        }, 1000);
                    }
                    return;
                }

                // 3. ê¸°ì¡´ ë ˆì½”ë“œê°€ ì—†ëŠ” ê²½ìš° ìƒˆë¡œ ë“±ë¡
                const { error: insertRecordError } = await supabaseClient
                    .from('iron_member_records')
                    .insert([
                        {
                            member_id: memberId,
                            year: year,
                            month: month,
                            sport: sport,
                            target_mileage: targetMileage
                        }
                    ]);

                if (insertRecordError) throw insertRecordError;

                showAlert('registerAlert', 'ëª©í‘œ ë§ˆì¼ë¦¬ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('memberName').value = '';
                document.getElementById('targetMileage').value = '';
                const sportRadios = document.querySelectorAll('input[name="sport"]');
                sportRadios.forEach(radio => radio.checked = false);
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                updateRegisterButtonText();

                // ë©¤ë²„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    loadMembers();
                }, 1000);
            } catch (error) {
                console.error('ë©¤ë²„ ë“±ë¡ ì˜¤ë¥˜:', error);
                showAlert('registerAlert', 'ë©¤ë²„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë§ˆì¼ë¦¬ì§€ ì¶”ê°€ (ëˆ„ì  ë°©ì‹)
        async function addOrUpdateMileage() {
            if (!currentMember) {
                showAlert('registerAlert', 'ë©¤ë²„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'error');
                return;
            }

            const sport = document.getElementById('mileageSport').value;
            const year = parseInt(document.getElementById('mileageYear').value);
            const month = parseInt(document.getElementById('mileageMonth').value);
            const distance = parseFloat(document.getElementById('mileageDistance').value);

            if (!sport) {
                alert('ì¢…ëª©ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!distance || distance <= 0) {
                alert('ë§ˆì¼ë¦¬ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            try {
                // í•­ìƒ ìƒˆ ë ˆì½”ë“œë¡œ ì¶”ê°€ (ëˆ„ì  ë°©ì‹)
                const { data, error } = await supabaseClient
                    .from('iron_mileages')
                    .insert([
                        {
                            member_id: currentMember.id,
                            member_name: currentMember.name,
                            sport: sport,
                            year: year,
                            month: month,
                            distance: distance,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select();

                if (error) throw error;

                alert('ë§ˆì¼ë¦¬ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('mileageDistance').value = '';
                document.getElementById('existingMileageInfo').innerHTML = '';
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                updateMileageButtonText();
                
                // ê¸°ì¡´ ë§ˆì¼ë¦¬ì§€ ì •ë³´ ìƒˆë¡œê³ ì¹¨
                loadExistingMileage();
                
                // í˜„í™© ìƒˆë¡œê³ ì¹¨
                loadMileageStats();
            } catch (error) {
                console.error('ë§ˆì¼ë¦¬ì§€ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ë§ˆì¼ë¦¬ì§€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¢…ëª©ë³„ íƒ­ ìƒì„±
        function createSportTabs(member) {
            const sportTabs = document.getElementById('sportTabs');
            sportTabs.innerHTML = '';
            
            // ëª¨ë“  ì¢…ëª© íƒ­ í‘œì‹œ
            const allSports = ['ìˆ˜ì˜', 'ëŸ¬ë‹', 'ì‚¬ì´í´'];
            const memberSports = member && member.sports ? member.sports.split(',').map(s => s.trim()) : [];
            
            allSports.forEach((sport, index) => {
                const tab = document.createElement('button');
                tab.className = 'sport-tab';
                tab.dataset.sport = sport;
                tab.textContent = sport;
                tab.onclick = () => switchSportTab(sport);
                
                // ë©¤ë²„ê°€ ë“±ë¡í•˜ì§€ ì•Šì€ ì¢…ëª©ì€ ë¹„í™œì„±í™”
                if (member && memberSports.length > 0 && !memberSports.includes(sport)) {
                    tab.style.opacity = '0.5';
                    tab.style.cursor = 'not-allowed';
                    tab.disabled = true;
                }
                
                if (index === 0) {
                    tab.classList.add('active');
                    currentSport = sport;
                }
                sportTabs.appendChild(tab);
            });
        }

        // ì¢…ëª©ë³„ íƒ­ ì „í™˜
        async function switchSportTab(sport) {
            currentSport = sport;
            
            // íƒ­ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.sport-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`.sport-tab[data-sport="${sport}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // í•´ë‹¹ ì¢…ëª©ì˜ ë¹„êµ ë©¤ë²„ ëª©ë¡ìœ¼ë¡œ ë³µì› ë° ì—…ë°ì´íŠ¸
            await updateCompareMemberSelects();
            
            // í˜„í™© ìƒˆë¡œê³ ì¹¨
            if (currentMember) {
                loadMileageStats();
                await updateComparison();
            }
        }

        // ë§ˆì¼ë¦¬ì§€ í˜„í™© ë¡œë“œ
        async function loadMileageStats() {
            if (!currentMember) return;

            try {
                const currentYear = parseInt(document.getElementById('mileageYear').value);
                const currentMonth = parseInt(document.getElementById('mileageMonth').value);

                // í•´ë‹¹ ì›”ì˜ ë§ˆì¼ë¦¬ì§€ ì¡°íšŒ (ì¢…ëª©ë³„ í•„í„°ë§)
                const { data: monthlyData, error: monthlyError } = await supabaseClient
                    .from('iron_mileages')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .eq('year', currentYear)
                    .eq('month', currentMonth)
                    .eq('sport', currentSport);

                if (monthlyError) throw monthlyError;

                // í•´ë‹¹ ë…„ë„ì˜ ë§ˆì¼ë¦¬ì§€ ì¡°íšŒ (ì¢…ëª©ë³„ í•„í„°ë§)
                const { data: yearlyData, error: yearlyError } = await supabaseClient
                    .from('iron_mileages')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .eq('year', currentYear)
                    .eq('sport', currentSport);

                if (yearlyError) throw yearlyError;

                // ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë ˆì½”ë“œ ì¡°íšŒ
                const { data: targetRecord, error: targetError } = await supabaseClient
                    .from('iron_member_records')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .eq('year', currentYear)
                    .eq('month', currentMonth)
                    .eq('sport', currentSport)
                    .single();

                if (targetError && targetError.code !== 'PGRST116') {
                    throw targetError;
                }

                // ëª©í‘œ ë‹¬ì„±ë¥  ê³„ì‚°
                const totalMileage = monthlyData.reduce((sum, item) => sum + item.distance, 0);
                const targetMileage = targetRecord ? targetRecord.target_mileage : 0;
                const achievementRate = targetMileage > 0 ? (totalMileage / targetMileage) * 100 : 0;

                // ì§„í–‰ë¥  í‘œì‹œ
                displayProgress(achievementRate, totalMileage, targetMileage, currentYear, currentMonth, currentSport);

                // ë…„ë„ë³„ ì¶”ì´ í‘œì‹œ
                await displayYearlyChart(yearlyData, currentYear, currentMember, currentSport);

                // í˜„í™© í‘œì‹œ
                document.getElementById('mileageStats').classList.remove('hidden');
            } catch (error) {
                console.error('ë§ˆì¼ë¦¬ì§€ í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì§„í–‰ë¥  í‘œì‹œ
        function displayProgress(rate, current, target, year, month, sport) {
            const container = document.getElementById('progressContainer');
            // km ë‹¨ìœ„ë¡œ í™˜ì‚° (ë¯¸í„°ë¥¼ 1000ìœ¼ë¡œ ë‚˜ëˆ”, ë°˜ì˜¬ë¦¼ ì—†ì´ ë‚´ë¦¼)
            const currentKm = (Math.floor(current / 100) / 10).toFixed(1);
            const targetKm = (Math.floor(target / 100) / 10).toFixed(1);
            const rateValue = Math.min(rate, 100);
            const rateText = `${rateValue.toFixed(1)}%`;
            
            container.innerHTML = `
                <div style="margin-bottom: 10px; font-size: 16px; font-weight: bold;">
                    ${year}ë…„ ${month}ì›” ëª©í‘œ ë‹¬ì„±ë¥ 
                </div>
                <div class="progress-bar" style="height: 30px; position: relative; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1);">
                    <div class="progress-fill" style="width: ${rateValue}%; height: 100%; background: #667eea; transition: width 0.3s ease; position: absolute; top: 0; left: 0; z-index: 1;"></div>
                    <div class="progress-text" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: ${rateValue >= 50 ? '#fff' : '#333'}; text-shadow: ${rateValue >= 50 ? '1px 1px 2px rgba(0,0,0,0.5)' : 'none'}; pointer-events: none; z-index: 2;">
                        ${rateText}
                    </div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <div>í˜„ì¬: ${currentKm}km / ëª©í‘œ: ${targetKm}km</div>
                </div>
            `;
        }

        // ë…„ë„ë³„ ì¶”ì´ í‘œì‹œ (Chart.js ì‚¬ìš©)
        async function displayYearlyChart(data, year, member, sport, targetRecord) {
            // ì œëª© ì—…ë°ì´íŠ¸
            const titleElement = document.getElementById('yearlyChartTitle');
            if (titleElement && year) {
                titleElement.textContent = `${year}ë…„ ${sport} ì›”ë³„ ëª©í‘œ ë‹¬ì„±ë¥  ì¶”ì´`;
            }
            
            // ì›”ë³„ ë‹¬ì„± ë§ˆì¼ë¦¬ì§€ ì§‘ê³„ (ìˆ«ì í‚¤ë¡œ ì €ì¥)
            const monthlyTotals = {};
            
            data.forEach(item => {
                const monthNum = item.month; // ìˆ«ìë¡œ ì €ì¥
                if (!monthlyTotals[monthNum]) {
                    monthlyTotals[monthNum] = 0;
                }
                monthlyTotals[monthNum] += item.distance;
            });

            // í•´ë‹¹ ë…„ë„ì˜ ëª¨ë“  ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë ˆì½”ë“œ ì¡°íšŒ
            const { data: allTargetRecords, error: recordsError } = await supabaseClient
                .from('iron_member_records')
                .select('*')
                .eq('member_id', member.id)
                .eq('year', year)
                .eq('sport', sport);

            if (recordsError) {
                console.error('ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë ˆì½”ë“œ ì¡°íšŒ ì˜¤ë¥˜:', recordsError);
            }

            // ì›”ë³„ ëª©í‘œ ë§ˆì¼ë¦¬ì§€ ë§µ ìƒì„±
            const monthlyTargets = {};
            if (allTargetRecords) {
                allTargetRecords.forEach(record => {
                    monthlyTargets[record.month] = record.target_mileage;
                });
            }

            const months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            
            // ë‹¬ì„±ë¥  ë°ì´í„° ì¤€ë¹„ (12ê°œì›” ëª¨ë‘)
            const achievementRates = [];
            const achievementRatesOver100 = [];
            const monthLabels = [];

            months.forEach((monthNum) => {
                const achieved = monthlyTotals[monthNum] || 0;
                const monthTargetMileage = monthlyTargets[monthNum] || 0;
                
                monthLabels.push(`${monthNum}ì›”`);
                
                if (monthTargetMileage > 0) {
                    // ëª©í‘œê°€ ìˆëŠ” ê²½ìš°: ë‹¬ì„±ë¥  ê³„ì‚°
                    const achievementRate = (achieved / monthTargetMileage) * 100;
                    
                    if (achievementRate <= 100) {
                        achievementRates.push(achievementRate);
                        achievementRatesOver100.push(0);
                    } else {
                        // 100% ì´ˆê³¼ì¸ ê²½ìš°
                        achievementRates.push(100);
                        achievementRatesOver100.push(achievementRate - 100);
                    }
                } else {
                    // ëª©í‘œê°€ ì—†ëŠ” ê²½ìš°: 0ìœ¼ë¡œ í‘œì‹œ
                    achievementRates.push(0);
                    achievementRatesOver100.push(0);
                }
            });

            // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
            const chartCanvas = document.getElementById('yearlyChart');
            if (yearlyChartInstance) {
                yearlyChartInstance.destroy();
                yearlyChartInstance = null;
            }

            // Chart.jsë¡œ ìŠ¤íƒ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„±
            const ctx = chartCanvas.getContext('2d');
            yearlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'ë‹¬ì„±ë¥ ',
                            data: achievementRates,
                            backgroundColor: '#fee500',
                            borderColor: '#fee500',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: '100% ì´ˆê³¼',
                            data: achievementRatesOver100,
                            backgroundColor: '#4caf50',
                            borderColor: '#4caf50',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const datasetLabel = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (datasetLabel === '100% ì´ˆê³¼') {
                                        return `${datasetLabel}: ${value.toFixed(1)}%`;
                                    } else if (value > 0) {
                                        return `${datasetLabel}: ${value.toFixed(1)}%`;
                                    }
                                    return 'ëª©í‘œ ì—†ìŒ';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            stacked: true, // ìŠ¤íƒ ëª¨ë“œ í™œì„±í™”
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: '#e0e0e0',
                                lineWidth: 1,
                                drawBorder: false
                            }
                        },
                        x: {
                            stacked: true, // ìŠ¤íƒ ëª¨ë“œ í™œì„±í™”
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        // ì „ì²´ ìˆœìœ„ í‘œì‹œ
        async function displayRanking() {
            try {
                const { data, error } = await supabaseClient
                    .from('iron_mileages')
                    .select('member_name, distance');

                if (error) throw error;

                const totals = {};
                data.forEach(item => {
                    if (!totals[item.member_name]) {
                        totals[item.member_name] = 0;
                    }
                    totals[item.member_name] += item.distance;
                });

                const ranking = Object.entries(totals)
                    .map(([name, total]) => ({ name, total }))
                    .sort((a, b) => b.total - a.total);

                const rankingList = document.getElementById('rankingList');
                rankingList.innerHTML = '';

                ranking.forEach((item, index) => {
                    const rankingItem = document.createElement('div');
                    rankingItem.className = 'ranking-item';
                    rankingItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="ranking-number">${index + 1}</span>
                            <span>${item.name}</span>
                        </div>
                        <span style="font-weight: bold;">${item.total.toLocaleString()}m</span>
                    `;
                    rankingList.appendChild(rankingItem);
                });
            } catch (error) {
                console.error('ìˆœìœ„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¹„êµ ë©¤ë²„ ì„ íƒ ì—…ë°ì´íŠ¸ (í•´ë‹¹ ì¢…ëª©ì„ ë“±ë¡í•œ ë©¤ë²„ë§Œ í‘œì‹œ)
        async function updateCompareMemberSelects() {
            const select = document.getElementById('compareMemberSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

            if (!currentSport) return;

            try {
                // 1. í•´ë‹¹ ì¢…ëª©ì„ ë“±ë¡í•œ ë©¤ë²„ ID ëª©ë¡ ì¡°íšŒ (ì¤‘ë³µ ì œê±°)
                const { data: records, error: recordsError } = await supabaseClient
                    .from('iron_member_records')
                    .select('member_id')
                    .eq('sport', currentSport);

                if (recordsError) throw recordsError;

                // ê³ ìœ í•œ member_idë§Œ ì¶”ì¶œ
                const uniqueMemberIds = new Set();
                if (records) {
                    records.forEach(record => {
                        if (record.member_id) {
                            uniqueMemberIds.add(record.member_id);
                        }
                    });
                }

                // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ID ì œì™¸
                if (currentMember) {
                    uniqueMemberIds.delete(currentMember.id);
                }

                // í˜„ì¬ ì¢…ëª©ì˜ ë¹„êµ ë©¤ë²„ ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const currentCompareMembers = compareMembersBySport[currentSport] || [];
                const currentCompareMemberIds = new Set(currentCompareMembers.map(m => m.id));

                // ì´ë¯¸ ì¶”ê°€ëœ ë¹„êµ ë©¤ë²„ ID ì œì™¸
                currentCompareMemberIds.forEach(id => uniqueMemberIds.delete(id));

                // 2. ê³ ìœ í•œ ë©¤ë²„ IDë¡œ ë©¤ë²„ ì •ë³´ ì¡°íšŒ
                if (uniqueMemberIds.size > 0) {
                    const memberIdsArray = Array.from(uniqueMemberIds);
                    
                    // Supabaseì˜ in() ì¿¼ë¦¬ëŠ” ìµœëŒ€ 1000ê°œê¹Œì§€ ì§€ì›í•˜ë¯€ë¡œ ì•ˆì „
                    const { data: members, error: membersError } = await supabaseClient
                        .from('iron_members')
                        .select('id, name')
                        .in('id', memberIdsArray)
                        .order('name');

                    if (membersError) throw membersError;
                    
                    // ì¡°íšŒëœ ë©¤ë²„ë“¤ë„ ì¤‘ë³µ ì œê±° (ê°™ì€ IDê°€ ì—¬ëŸ¬ ë²ˆ ë‚˜ì˜¬ ê²½ìš° ëŒ€ë¹„)
                    const uniqueMembersMap = new Map();
                    if (members) {
                        members.forEach(member => {
                            if (member.id && !uniqueMembersMap.has(member.id)) {
                                uniqueMembersMap.set(member.id, member);
                            }
                        });
                    }
                    const uniqueMembers = Array.from(uniqueMembersMap.values());

                    // select boxì— ì¶”ê°€ (ì¤‘ë³µ ì²´í¬ ê°•í™”)
                    if (uniqueMembers && uniqueMembers.length > 0) {
                        // ì´ë¯¸ ì¶”ê°€ëœ optionì˜ valueë¥¼ Setìœ¼ë¡œ ê´€ë¦¬
                        const addedOptionValues = new Set();
                        
                        // ê¸°ì¡´ optionë“¤ì˜ value ìˆ˜ì§‘ (ì„ íƒí•˜ì„¸ìš” ì œì™¸)
                        for (let i = 1; i < select.options.length; i++) {
                            if (select.options[i].value) {
                                addedOptionValues.add(select.options[i].value);
                            }
                        }
                        
                        uniqueMembers.forEach(member => {
                            // ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ IDëŠ” ê±´ë„ˆë›°ê¸°
                            if (addedOptionValues.has(member.id)) {
                                return;
                            }
                            
                            const option = document.createElement('option');
                            option.value = member.id;
                            option.textContent = member.name;
                            select.appendChild(option);
                            addedOptionValues.add(member.id);
                        });
                    }
                }
            } catch (error) {
                console.error('ë¹„êµ ë©¤ë²„ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¹„êµ ë©¤ë²„ ì¶”ê°€
        async function addCompareMember() {
            const select = document.getElementById('compareMemberSelect');
            const memberId = select.value;

            if (!memberId) {
                alert('ë¹„êµí•  ë©¤ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            // í˜„ì¬ ì¢…ëª©ì˜ ë¹„êµ ë©¤ë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const currentCompareMembers = compareMembersBySport[currentSport] || [];

            // ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ì¸ì§€ í™•ì¸
            if (currentCompareMembers.find(m => m.id === memberId)) {
                alert('ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ì…ë‹ˆë‹¤.');
                return;
            }

            // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ì™€ ë™ì¼í•œì§€ í™•ì¸
            if (currentMember && currentMember.id === memberId) {
                alert('í˜„ì¬ ì„ íƒëœ ë©¤ë²„ëŠ” ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.');
                return;
            }

            const member = allMembers.find(m => m.id === memberId);
            if (!member) {
                alert('ë©¤ë²„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // í˜„ì¬ ì¢…ëª©ì˜ ë¹„êµ ë©¤ë²„ ëª©ë¡ì— ì¶”ê°€
            if (!compareMembersBySport[currentSport]) {
                compareMembersBySport[currentSport] = [];
            }
            compareMembersBySport[currentSport].push(member);
            select.value = '';
            
            // select box ì—…ë°ì´íŠ¸ (ì¶”ê°€ëœ ë©¤ë²„ ì œì™¸)
            await updateCompareMemberSelects();
            
            // ë¹„êµ í‘œì‹œ ì—…ë°ì´íŠ¸
            await updateComparison();
        }

        // ë¹„êµ ì—…ë°ì´íŠ¸
        async function updateComparison() {
            const currentYear = parseInt(document.getElementById('mileageYear').value);
            const currentMonth = parseInt(document.getElementById('mileageMonth').value);

            if (!currentMember) {
                document.getElementById('comparisonContainer').innerHTML = '';
                return;
            }

            try {
                const comparisons = [];

                // 1. ë””í´íŠ¸ ë©¤ë²„ (í˜„ì¬ ì„ íƒëœ ë©¤ë²„) ì •ë³´ ì¡°íšŒ
                const { data: defaultData } = await supabaseClient
                    .from('iron_mileages')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .eq('year', currentYear)
                    .eq('month', currentMonth)
                    .eq('sport', currentSport);

                const { data: defaultTargetRecord } = await supabaseClient
                    .from('iron_member_records')
                    .select('*')
                    .eq('member_id', currentMember.id)
                    .eq('year', currentYear)
                    .eq('month', currentMonth)
                    .eq('sport', currentSport)
                    .single();

                const defaultTotal = defaultData ? defaultData.reduce((sum, item) => sum + item.distance, 0) : 0;
                const defaultTarget = defaultTargetRecord ? defaultTargetRecord.target_mileage : 0;
                
                comparisons.push({
                    id: currentMember.id,
                    name: currentMember.name,
                    target: defaultTarget,
                    current: defaultTotal,
                    rate: defaultTarget > 0 ? (defaultTotal / defaultTarget) * 100 : 0,
                    isDefault: true
                });

                // 2. í˜„ì¬ ì¢…ëª©ì˜ ì¶”ê°€ëœ ë¹„êµ ë©¤ë²„ë“¤ ì •ë³´ ì¡°íšŒ
                const currentCompareMembers = compareMembersBySport[currentSport] || [];
                for (const compareMember of currentCompareMembers) {
                    const { data: compareData } = await supabaseClient
                        .from('iron_mileages')
                        .select('*')
                        .eq('member_id', compareMember.id)
                        .eq('year', currentYear)
                        .eq('month', currentMonth)
                        .eq('sport', currentSport);

                    const { data: compareTargetRecord } = await supabaseClient
                        .from('iron_member_records')
                        .select('*')
                        .eq('member_id', compareMember.id)
                        .eq('year', currentYear)
                        .eq('month', currentMonth)
                        .eq('sport', currentSport)
                        .single();

                    const compareTotal = compareData ? compareData.reduce((sum, item) => sum + item.distance, 0) : 0;
                    const compareTarget = compareTargetRecord ? compareTargetRecord.target_mileage : 0;
                    
                    comparisons.push({
                        id: compareMember.id,
                        name: compareMember.name,
                        target: compareTarget,
                        current: compareTotal,
                        rate: compareTarget > 0 ? (compareTotal / compareTarget) * 100 : 0,
                        isDefault: false
                    });
                }

                displayComparison(comparisons);
            } catch (error) {
                console.error('ë¹„êµ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ë¹„êµ í‘œì‹œ
        function displayComparison(comparisons) {
            const container = document.getElementById('comparisonContainer');
            container.innerHTML = '';

            if (comparisons.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ë¹„êµí•  ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>';
                return;
            }

            // ì¤‘ë³µ ì œê±° (ê°™ì€ IDë¥¼ ê°€ì§„ ë©¤ë²„ëŠ” í•˜ë‚˜ë§Œ í‘œì‹œ)
            const uniqueComparisons = [];
            const seenIds = new Set();
            
            comparisons.forEach(comp => {
                if (!seenIds.has(comp.id)) {
                    seenIds.add(comp.id);
                    uniqueComparisons.push(comp);
                }
            });

            uniqueComparisons.forEach((comp, index) => {
                const card = document.createElement('div');
                card.className = 'comparison-card';
                card.style.marginBottom = '15px';
                card.style.padding = '15px';
                card.style.border = comp.isDefault ? '2px solid #667eea' : '1px solid #e0e0e0';
                card.style.borderRadius = '8px';
                card.style.backgroundColor = comp.isDefault ? '#f0f4ff' : '#fff';
                
                const rate = Math.min(comp.rate, 100);
                const rateText = `${rate.toFixed(1)}%`;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; font-size: 16px; ${comp.isDefault ? 'color: #667eea; font-weight: bold;' : ''}">
                            ${comp.isDefault ? 'â­ ' : ''}${comp.name}
                        </h4>
                        ${!comp.isDefault ? `<button onclick="removeCompareMember('${comp.id}')" style="background: #ff4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">ì œê±°</button>` : ''}
                    </div>
                    <div class="progress-bar" style="height: 30px; position: relative; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1);">
                        <div class="progress-fill" style="width: ${rate}%; height: 100%; background: ${comp.isDefault ? '#667eea' : '#fee500'}; transition: width 0.3s ease; position: absolute; top: 0; left: 0; z-index: 1;"></div>
                        <div class="progress-text" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: ${rate >= 50 ? '#fff' : '#333'}; text-shadow: ${rate >= 50 ? '1px 1px 2px rgba(0,0,0,0.5)' : 'none'}; pointer-events: none; z-index: 2;">
                            ${rateText}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ë¹„êµ ë©¤ë²„ ì œê±°
        async function removeCompareMember(memberId) {
            // í˜„ì¬ ì¢…ëª©ì˜ ë¹„êµ ë©¤ë²„ ëª©ë¡ì—ì„œ ì œê±°
            if (compareMembersBySport[currentSport]) {
                compareMembersBySport[currentSport] = compareMembersBySport[currentSport].filter(m => m.id !== memberId);
            }
            
            // select box ì—…ë°ì´íŠ¸ (ì œê±°ëœ ë©¤ë²„ ë‹¤ì‹œ í‘œì‹œ)
            await updateCompareMemberSelects();
            
            // ë¹„êµ í‘œì‹œ ì—…ë°ì´íŠ¸
            await updateComparison();
        }

        // ì´ë ¥ ì¡°íšŒ ë©¤ë²„ ì„ íƒ ì—…ë°ì´íŠ¸
        function updateHistoryMemberSelect() {
            const select = document.getElementById('historyMember');
            select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';

            allMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                select.appendChild(option);
            });
        }

        // ì´ë ¥ ë¡œë“œ (ì˜¤ëŠ˜ ê¸°ì¤€ í•´ë‹¹ì›” ë°ì´í„°ë§Œ)
        async function loadHistory() {
            const memberId = document.getElementById('historyMember').value;
            if (!memberId) {
                document.getElementById('historyList').innerHTML = '';
                return;
            }

            try {
                // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë…„ë„ì™€ ì›” ê°€ì ¸ì˜¤ê¸°
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth() + 1;

                const { data, error } = await supabaseClient
                    .from('iron_mileages')
                    .select('*')
                    .eq('member_id', memberId)
                    .eq('year', currentYear)
                    .eq('month', currentMonth)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayHistory(data, currentYear, currentMonth);
            } catch (error) {
                console.error('ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì´ë ¥ í‘œì‹œ
        function displayHistory(data, year, month) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (data.length === 0) {
                historyList.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">${year}ë…„ ${month}ì›”ì— ë“±ë¡ëœ ë§ˆì¼ë¦¬ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            data.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.created_at);
                const dateStr = date.toLocaleString('ko-KR', {
                    year: '2-digit',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const sportBadgeClass = {
                    'ìˆ˜ì˜': 'badge-swim',
                    'ëŸ¬ë‹': 'badge-run',
                    'ì‚¬ì´í´': 'badge-cycle'
                }[item.sport] || '';

                // km ë‹¨ìœ„ë¡œ í™˜ì‚°
                const km = Math.floor((item.distance / 1000) * 100) / 100;
                const kmText = km.toFixed(2);

                historyItem.innerHTML = `
                    <div class="history-item-info">
                        <div class="history-item-date">${dateStr}</div>
                        <div class="history-item-details">
                            <span class="badge ${sportBadgeClass}">${item.sport}</span>
                            ${kmText} km (${item.distance.toLocaleString()}m)
                        </div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="deleteMileage('${item.id}')">ì‚­ì œ</button>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // ë§ˆì¼ë¦¬ì§€ ì‚­ì œ
        async function deleteMileage(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabaseClient
                    .from('iron_mileages')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('ë§ˆì¼ë¦¬ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadHistory();
                if (currentMember) {
                    loadMileageStats();
                }
            } catch (error) {
                console.error('ë§ˆì¼ë¦¬ì§€ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ë§ˆì¼ë¦¬ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
        function shareKakao() {
            if (!currentMember) {
                alert('ë©¤ë²„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            const now = new Date().toLocaleString('ko-KR');

            Kakao.Share.sendDefault({
                objectType: 'text',
                text: `ğŸ¦¾ ë‚˜ë„ ì² ì¸ ë¼ë³´ì¹´? í˜„í™©\n\n${currentMember.name}ë‹˜ì˜ ${currentYear}ë…„ ${currentMonth}ì›” ëª©í‘œ ë‹¬ì„± í˜„í™©ì„ í™•ì¸í•´ë³´ì„¸ìš”!\n\ní˜„ì¬ ì‹œê°: ${now}\n\nì›¹ì‚¬ì´íŠ¸ì—ì„œ ë” ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.`,
                link: {
                    mobileWebUrl: window.location.href,
                    webUrl: window.location.href,
                },
            });
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';

            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
